import groovy.json.JsonSlurper
import javax.net.ssl.HttpsURLConnection
import org.apache.http.client.methods.HttpPut
import org.apache.http.impl.client.DefaultHttpClient
import org.apache.http.entity.mime.MultipartEntity
import org.apache.http.entity.mime.HttpMultipartMode;
import org.apache.http.entity.mime.content.FileBody
import org.apache.http.HttpVersion
import org.apache.http.params.CoreProtocolPNames
import org.apache.http.impl.client.DefaultConnectionKeepAliveStrategy
import org.apache.http.HttpResponse
import org.apache.http.protocol.HttpContext
import org.apache.http.util.EntityUtils

buildscript {
  repositories {
    maven {
      url = 'http://kellyrob99.github.com/Jenkins-api-tour/repository'
    }
    mavenCentral()
  }
  dependencies {
    classpath 'org.kar:gradle-jslint-plugin:0.2'
    classpath 'org.apache.httpcomponents:httpclient:4.2.1'
    classpath 'org.apache.httpcomponents:httpmime:4.2.1'

  }
}

repositories {
  mavenCentral() //needed by the plugin to retrieve the jslint jar
}

dependencies {
}

apply plugin: 'jslint'

jslint {
  inputDirs = ['assets/www/']
  haltOnFailure = false
  excludes = '**/cordova*.js,**/*.min.js,**/*-min.js,**/spec/lib/**/*.js'
  options = 'rhino'
  formatterType = 'xml'
}

def archiveFile = 'su.tar.gz'
def appId = '219084'
def user = 'utveckling@it.su.se'
def pass = System.getenv('PG_PASS')

task replaceCordova << {

  new File('assets/www/').eachFileMatch(~/cordova.*\.js/) { f -> f.delete() }

  new File("assets/").eachDirRecurse() { dir ->
    dir.eachFileMatch(~/.*\.html/) { file ->
      def text = file.text
      file.write(text.replaceAll(/cordova-.*\.js/, 'phonegap.js'))
    }
  }
}

task removeTar << {
  // Remove old zip file
  def zipFile = new File(archiveFile)
  zipFile.delete()
}

task buildTar(type: Tar, dependsOn: [replaceCordova, removeTar]) {
  archiveName archiveFile
  compression Compression.GZIP
  includes["www"]
  from new File("assets/")
}

buildTar {
  outputs.upToDateWhen { false }
}

task toPhonegap(dependsOn: buildTar) {
  doLast {

    def token = getToken(user, pass)
    def apiCall = "https://build.phonegap.com/api/v1/apps/${appId}?auth_token=${token}"

    DefaultHttpClient httpclient = new DefaultHttpClient();
    httpclient.getParams().setParameter(CoreProtocolPNames.PROTOCOL_VERSION, HttpVersion.HTTP_1_1);
    HttpPut httpPut = new HttpPut(apiCall)
    httpPut.getParams().setBooleanParameter(CoreProtocolPNames.USE_EXPECT_CONTINUE, true)
    httpPut.setHeader("Accept", "*/*")

    MultipartEntity mp = new MultipartEntity(HttpMultipartMode.BROWSER_COMPATIBLE);
    FileBody fileBody = new FileBody(new File(archiveFile), "binary/octet-stream");
    mp.addPart('file', fileBody);
    httpPut.setEntity(mp);
    HttpResponse response = httpclient.execute(httpPut)

    def status = response.statusLine.statusCode

    if (status != 200)
      throw new Exception("Failed to publish to phonegap: ${status}: ${response.statusLine.reasonPhrase}")
    else {

      def json = new JsonSlurper().parseText(EntityUtils.toString(response.entity))

      if (json?.error?.size() > 0)
        throw new Exception("Error during publish to phonegap: ${json.error}")
      else
        println "Successfully published app '${json.title}' v${json.version} build nr ${json.build_count} to phonegap."
    }
  }
}

task wrapper(type: Wrapper) {
  gradleVersion = '1.2'
}

String getToken(String user, String pass) {

  def authString = "${user}:${pass}".getBytes().encodeBase64().toString()

  def connection = (HttpsURLConnection) "https://build.phonegap.com/token".toURL().openConnection()
  connection.setRequestProperty("Authorization", "Basic ${authString}")
  connection.setRequestProperty("Accept", "application/json")
  connection.requestMethod = "POST"

  if (connection?.responseCode != 200)
    throw new Exception("Failed to get token: ${connection?.responseCode}: ${connection?.responseMessage}")

  def json = new JsonSlurper().parseText(connection?.content?.text)
  json?.token
}
